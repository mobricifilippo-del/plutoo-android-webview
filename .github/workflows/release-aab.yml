name: Android Release (AAB)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      KEYSTORE_PATH: ${{ github.workspace }}/keystore.jks

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17 (Temurin)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Accept Android SDK licenses
        run: yes | sdkmanager --licenses

      - name: Install Gradle 8.7 (no wrapper)
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: "8.7"

      - name: Prepare keystore for signing
        if: env.KEYSTORE_B64 != ''
        run: |
          echo "$KEYSTORE_B64" | base64 -d > "$KEYSTORE_PATH"
          ls -l "$KEYSTORE_PATH"

      - name: Build bundleRelease (signed by Gradle)
        run: >
          gradle clean :app:bundleRelease --stacktrace
          -Pandroid.injected.signing.store.file="$KEYSTORE_PATH"
          -Pandroid.injected.signing.store.password="${KEYSTORE_PASSWORD}"
          -Pandroid.injected.signing.key.alias="${KEY_ALIAS}"
          -Pandroid.injected.signing.key.password="${KEY_PASSWORD}"

      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: app-release.aab
          path: app/build/outputs/bundle/release/*.aab
